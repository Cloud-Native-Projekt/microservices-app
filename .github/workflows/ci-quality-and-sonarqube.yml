# .github/workflows/ci-quality-and-sonar.yml
name: CI ⇒ Lint, Test & SonarQube

on:
  pull_request:
    # Run on PR open/reopen/sync/etc. against main
    branches:
      - main
  push:
    # Also run on pushes to feature branches even before merge
    branches:
      - 'feature/**'

env:
  SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
  SONAR_TOKEN:    ${{ secrets.SONAR_TOKEN }}

jobs:
  sonar:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0                   # needed to get full git history for branch detection

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install SonarScanner CLI
        run: |
          curl -sSLo sonar-scanner-cli.zip \
            https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-7.1.0.4889-linux-x64.zip
          unzip -q sonar-scanner-cli.zip

      - name: Add SonarScanner to PATH
        run: echo "${{ github.workspace }}/sonar-scanner/bin" >> $GITHUB_PATH

      - name: Run SonarQube Scanner
        run: |
          # Determine current branch name:
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BRANCH=${{ github.event.pull_request.head.ref }}
          else
            BRANCH=${GITHUB_REF#refs/heads/}
          fi

          # Form a unique project key per branch:
          #    [your-project-base-key]-main     → main branch
          #    [your-project-base-key]-feature/x → feature branches
          PROJECT_KEY="myproj-${BRANCH//\//-}"

          sonar-scanner \
            -Dsonar.host.url="$SONAR_HOST_URL" \
            -Dsonar.login="$SONAR_TOKEN" \
            -Dsonar.projectKey="$PROJECT_KEY" \
            -Dsonar.projectName="Cloud Native Projekt (${BRANCH})" \
            -Dsonar.sources=./ \
            -Dsonar.python.version=3.13 \
            -Dsonar.branch.name="$BRANCH"
